<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-06-27 Mo 14:11 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tutorial IC Design</title>
<meta name="author" content="Prof. Alberto Garcia-Ortiz and Amir Najafi" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="../../../../www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="../../../../www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="../../../../ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="../../../../maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../../../www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.html"></script>
<script type="text/javascript" src="../../../../www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Tutorial IC Design</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org9ef4f56">1. Goals</a></li>
<li><a href="#org6f3fd07">2. Design the unit (RTL)</a></li>
<li><a href="#org001d98d">3. Lunch design compiler</a></li>
<li><a href="#org2e8b24d">4. DFT configuration and synthesis</a>
<ul>
<li><a href="#org205346e">4.1. Design import</a></li>
<li><a href="#org87ccf2b">4.2. First DFT Synthesis</a></li>
<li><a href="#orgd695fea">4.3. Second DFT Synthesis</a></li>
</ul>
</li>
<li><a href="#orgf12a879">5. ATPG</a>
<ul>
<li><a href="#org5a5fb54">5.1. Lunch TetraMAX</a></li>
<li><a href="#org406a380">5.2. Read the netlist and library files</a></li>
<li><a href="#orge5d7bfa">5.3. Build the design</a></li>
<li><a href="#org16f6d91">5.4. DRC check</a></li>
<li><a href="#orgdca65ad">5.5. Generate the test pattern</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org9ef4f56" class="outline-2">
<h2 id="org9ef4f56"><span class="section-number-2">1.</span> Goals</h2>
<div class="outline-text-2" id="text-1">
<p>
This tutorial is the extension of the Basic DFT tutorial. 
The goals of this tutorial are as follows:
</p>

<ul class="org-ul">
<li>Modify the design in order to deal with gated clocks and non-scan storage elements</li>
<li>Integrate the scan architechture into the design</li>
<li>Automatic Test Pattern Generation (ATPG)</li>
</ul>

<p>
In this tutorial, we use the waveform generator design.     
</p>
</div>
</div>


<div id="outline-container-org6f3fd07" class="outline-2">
<h2 id="org6f3fd07"><span class="section-number-2">2.</span> Design the unit (RTL)</h2>
<div class="outline-text-2" id="text-2">
<p>
Before we start with DFT synthesis, the design must be modify by adding some scan 
input and output pins. In addition to that, we have to deal with different design styles such as 
gated clocks. The waveform generator design is illustrated bellow:
</p>


<div id="org470ed55" class="figure">
<p><img src="figs/waveform_gen.png" alt="waveform_gen.png" />
</p>
</div>


<p>
In the terminal, go to the directory <code>dft_int/rtl</code> and open a text editor to open 
waveform genarator top design <code>waveform_gen.vhd</code>.  
</p>

<p>
In the terminal execute:
</p>
<div class="org-src-container">
<pre class="src src-sh">cd dft_int/rtl
</pre>
</div>

<p>
and then,
</p>
<div class="org-src-container">
<pre class="src src-sh">emacs waveform_gen.vhd &amp;
</pre>
</div>

<p>
To integrate the scan chain into the design, first, add the interfaces which is needed for design. 
We define SERIAL_IN, TESTMODE and SCAN_EN as input ports of form std_logic and 
SERIAL_OUT as output port of the std_logic. In addition to that, due to the unknown state of memory 
it should be bypassed. Therefore, the top vhdl code should be extended to bypass the memory. 
Finally, you should have such a vhdl code of your top design <i><b>waveform_gen</b></i> which is modified for scan integration:
</p>

<div class="org-src-container">
<pre class="src src-vhdl">library IEEE;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;
use work.parameter.all;

entity waveform_gen is
  port(
    clk,rst,start,mode,data_in : in std_logic;
    sync_rst_ram_addr : in std_logic;
    period_multiplier:in std_logic_vector(counter_sleep_width-1 downto 0);
    data_out: out std_logic_vector(bit_width_data-1 downto 0);
    sleep_reg: out std_logic_vector(counter_sleep_width-1 downto 0);
    ---------------------------------------------------------------------------
    SERIAL_IN, SCAN_EN, TESTMODE: in std_logic;                           --     Modified for TST
    SERIAL_OUT: out std_logic    
    );
  end entity;

architecture behaviour of waveform_gen is
  signal gated_clk,sleep_inv: std_logic;
  signal gated_clk2,sleep2_inv: std_logic;
  signal re_ram,we_ram,oe_ram,enable_reg_file,sleep,sleep2,enable_shift_reg: std_logic;
  signal addr_ram: std_logic_vector(size_ram_addr-1 downto 0);
  signal data_shift_reg,ram_out,ram_out_dft:std_logic_vector(bit_width_data-1 downto 0);
  -----------------------------------------------------------------------------
  signal RAMBO, RAMBO_out : std_logic_vector(bit_width_data-1 downto 0);  --     Modified for TST
  signal intEnRAM : std_logic;

begin


  sleep_inv &lt;= not sleep;
  sleep2_inv &lt;= not sleep2;

  clk_gate1:CLKGATE_X1
  port map(
      CK =&gt; clk,
      E =&gt; sleep_inv,
      GCK =&gt; gated_clk
      );

  clk_gate2:CLKGATE_X1
  port map(
      CK =&gt; clk,
      E =&gt; sleep2_inv,
      GCK =&gt; gated_clk2
      );  

  controller_main:fsm
  port map(
      clk=&gt; gated_clk,
      rst=&gt;rst,
      start=&gt;start,
      mode=&gt;mode,
      re_ram=&gt;re_ram,
      we_ram=&gt;we_ram,
      oe_ram=&gt;oe_ram,
      enable_shift_reg =&gt; enable_shift_reg
    );

  controller_sleep0:controller_sleep
  port map(
      clk=&gt;clk,
      rst=&gt;rst,
      re_ram =&gt; re_ram,
      we_ram =&gt; we_ram,
      addr_ram =&gt; addr_ram,
      sync_rst_ram_counter=&gt; sync_rst_ram_addr,
      sleep_time=&gt;period_multiplier,
      sleep=&gt;sleep,
      sleep2=&gt; sleep2,
      enable_reg_file =&gt; enable_reg_file,
      sleep_reg =&gt; sleep_reg
    );

  shift_reg_data_in:shift_reg
  port map(
    clk=&gt;gated_clk,
    rst=&gt;rst,
    data_in=&gt;data_in,
    ena=&gt;enable_shift_reg,
    data_out=&gt;data_shift_reg
    );

ram_block:SRAM64x8_1rw
  port map(
    CE=&gt;gated_clk,
    WEB=&gt;we_ram,
    REB=&gt;re_ram,
    OEB=&gt;intEnRAM,                      --     Modified for TST
    A=&gt;addr_ram,
    I=&gt; data_shift_reg,
    O=&gt; ram_out
    );   

  output_register:reg_file
  port map(
    clk=&gt;gated_clk2,
    rst =&gt; rst,
    ena =&gt; enable_reg_file,
    data_in =&gt; RAMBO_out,               --      Modified for TST      
    data_out =&gt; data_out
    ); 

  -----------------------------------------------------------------------------
  -- Added for TST
  -----------------------------------------------------------------------------

xor_reg:process(clk,rst) is
  begin
    if rst='0' then
      RAMBO &lt;= (others =&gt; '0');
    elsif clk='1' and clk'event then
      RAMBO &lt;= ((addr_ram &amp; we_ram &amp; re_ram) xor data_shift_reg);
    end if;
  end process xor_reg;

mux2:process(RAMBO ,ram_out, TESTMODE) is
  begin
    if TESTMODE='1' then
      RAMBO_out &lt;= RAMBO;
    else
      RAMBO_out &lt;= ram_out;
    end if;
  end process mux2;

mux1:process(oe_ram, TESTMODE) is
  begin
    if TESTMODE='1' then
      intEnRAM &lt;= '0';
    else
      intEnRAM &lt;= oe_ram;
    end if;
  end process mux1;


end architecture;

</pre>
</div>
</div>
</div>


<div id="outline-container-org001d98d" class="outline-2">
<h2 id="org001d98d"><span class="section-number-2">3.</span> Lunch design compiler</h2>
<div class="outline-text-2" id="text-3">
<p>
For this lab you are going to use the Design Compiler tool as well Tetramax from Synopsys  In the terminal, go to the directory <code>dft_int/do_synth</code>. 
for using the Design Compiler create a <code>sourceme.sh</code> file to do the setup.
</p>
<div class="org-src-container">
<pre class="src src-sh">export SNPSLMD_LICENSE_FILE=28231@item0096
export PATH=/usrf01/prog/synopsys/syn/R-2020.09-SP4/bin:${PATH}
</pre>
</div>

<p>
Now you can source that file.
</p>
<div class="org-src-container">
<pre class="src src-sh">source sourceme.sh
</pre>
</div>

<p>
Before you open the synthesis tool, it is practical to select the library of
standard cells that you use and to instruct the tool to save the log
files into the directories that you have previously defined. You can
do that creating a <code>.synopsys_dc.setup</code> file. Run <code>emacs .synopsys_dc.setup</code>.
</p>

<p>
First, you can add the following commands to your <code>.synopsys_dc.setup</code>
file; they instruct the tool to use your directories.
</p>

<div class="org-src-container">
<pre class="src src-tcl">define_design_lib work -path ./tool/work

set_app_var  view_log_file        ./log/synth_view.log
set_app_var  sh_command_log_file  ./log/synth_sh.log
set_app_var  filename_log_file    ./log/synth_file.log

set_app_var search_path       [concat ./cmd/  [get_app_var search_path] ]    
</pre>
</div>

<p>
And afterwards you can write the command to define the library to use. 
</p>

<div class="org-src-container">
<pre class="src src-tcl">set library_path "../../../0_FreePDK45/LIB/"
set library_name "NangateOpenCellLibrary_typical_ccs_scan.db"
set library_name2 "SRAM64x8_1rw.db"

set_app_var target_library    $library_name
set_app_var link_library      [concat $library_name $library_name2 dw_foundation.sldb "*"]
set_app_var search_path       [concat $library_path [get_app_var search_path] ]
set_app_var synthetic_library [list dw_foundation.sldb]
set_app_var symbol_library    [list class.sdb]

set_app_var vhdlout_use_packages { ieee.std_logic_1164.all  NangateOpenCellLibrary.Components.all }
set_app_var vhdlout_write_components FALSE
</pre>
</div>

<p>
Save  your file. Now you can start the tool. Launch <code>design_vision</code> in the terminal. To
save the log in a directory, you can add a linux pipe 
<code>tee log/synthesis.log</code> that redirects the log output to a file called <code>log/synthesis.log</code>. 
</p>
<div class="org-src-container">
<pre class="src src-sh">design_vision | tee log/synthesis.log &amp;
</pre>
</div>

<div id="org45a32bb" class="figure">
<p><img src="figs/design_vision.png" alt="design_vision.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org2e8b24d" class="outline-2">
<h2 id="org2e8b24d"><span class="section-number-2">4.</span> DFT configuration and synthesis</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org205346e" class="outline-3">
<h3 id="org205346e"><span class="section-number-3">4.1.</span> Design import</h3>
<div class="outline-text-3" id="text-4-1">
<p>
For the more complex designs, we usually write tcl commands in a separate file and source the files to 
set different options in the tool. Source <i><b>config_synthesis</b></i> tcl file to define all names and variable as well as list of vhdl files.
Then, use you can read the RTL codes using <i><b>read_design.tcl</b></i>.
</p>

<div class="org-src-container">
<pre class="src src-tcl">source ./cmd/config_synth.tcl
source ./cmd/read_design.tcl
</pre>
</div>

<p>
You can now set simple synthesis constraints using <i><b>global_constraints.tcl</b></i> file. 
</p>

<div class="org-src-container">
<pre class="src src-tcl">source ./cmd/global_constraints.tcl
</pre>
</div>

<p>
The tool reads and "understands" the code. In the log file you can see
the elements that it has inferred.
</p>


<div class="NOTE" id="orga2c13f9">
<p>
Have a look at the tcl files and make sure that you undestand all commands.
</p>

</div>
</div>
</div>

<div id="outline-container-org87ccf2b" class="outline-3">
<h3 id="org87ccf2b"><span class="section-number-3">4.2.</span> First DFT Synthesis</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Now, we are going to configure the DFT. There are many options which should be set to configure the DFT. 
Among all options, we set the clock, test period, type of scan cells, the reset, scan input and output, scan enable and test mode. 
There are three widly used scan cells, <i><b>Muxed-D</b></i> Scan Cell, <i><b>Clocked</b></i> Scan Cell and <i><b>LSSD</b></i> Scan Cell. 
we use <i><b>Muxed-D</b></i> scan cells.
</p>

<div class="org-src-container">
<pre class="src src-tcl">set_scan_configuration -style multiplexed_flip_flop
set test_default_period 100
set_dft_signal -view existing_dft -type ScanClock -timing {45 55} -port clk
set_dft_signal -view existing_dft -type Reset -active_state 0 -port rst
set_dft_signal -view spec -type ScanDataIn -port SERIAL_IN
set_dft_signal -view spec -type ScanDataOut -port SERIAL_OUT
set_dft_signal -view spec -type ScanEnable -port SCAN_EN -active_state 1
set_dft_signal -view existing_dft -type Constant -port TESTMODE -active_state 1
create_test_protocol
</pre>
</div>

<p>
You can copy the commands into a file to automatize your synthesis process. Create a file using <code>emacs cmd/dft_config.tcl</code> and copy the 
commands in it. Now you can begin the DFT synthesis. Execute the following commands:
</p>

<div class="org-src-container">
<pre class="src src-tcl">compile -scan
</pre>
</div>

<p>
Using this command, we do the compilation using scan option. Tool is replacing all the sequential elements 
by scan equivalent. 
</p>

<p>
You can search the design for DFT violations using the following command:
</p>
<div class="org-src-container">
<pre class="src src-tcl">dft_drc
</pre>
</div>

<p>
After that you can specify the scan chain. You can select the number and length of the scan chains.
We define only one scan chain for this design. In addition, we define that no different clock 
edges may occur in the scan chain. The input and output of the scan chain is also specified.
</p>

<div class="org-src-container">
<pre class="src src-tcl">set_scan_configuration -chain_count 1
set_scan_configuration -clock_mixing no_mix
set_scan_path chain1 -scan_data_in SERIAL_IN -scan_data_out SERIAL_OUT
</pre>
</div>

<p>
Then, the scan chain can be inserted into the design. In addition, the command 
<code>set_scan_state_scan_existing</code> indicates that the scan chain is fully implemented or not.
</p>
<div class="org-src-container">
<pre class="src src-tcl">insert_dft
set_scan_state scan_existing
</pre>
</div>

<p>
Check the schematic of your design. The scan chain inserted in the design.
</p>

<div class="org-src-container">
<pre class="src src-tcl">report_scan_path -view existing_dft -chain all &gt; reports/chain1.rep
report_scan_path -view existing_dft -cell all &gt; reports/cell1.rep
</pre>
</div>
</div>
</div>


<div id="outline-container-orgd695fea" class="outline-3">
<h3 id="orgd695fea"><span class="section-number-3">4.3.</span> Second DFT Synthesis</h3>
<div class="outline-text-3" id="text-4-3">
<p>
As you may have already noticed, your design contains gated clocks. To increase the testability of the design, the 
Further modificaiton of the design is necessary. In this step, replace the gated clock architecture with its test equivallent
architecture as follows: 
</p>

<div class="org-src-container">
<pre class="src src-vhdl">clk_gate1:CLKGATETST_X1               -- TEST CLOCK GATE
port map(
    CK =&gt; clk,
    E =&gt; sleep_inv,
    GCK =&gt; gated_clk,
    SE =&gt; TESTMODE
    );

clk_gate2:CLKGATETST_X1               -- TEST CLOCK GATE
port map(
    CK =&gt; clk,
    E =&gt; sleep2_inv,
    GCK =&gt; gated_clk2,
    SE =&gt; TESTMODE
    );   
</pre>
</div>

<p>
This standard cell uses an extra <i><b>OR</b></i> gate. This gate is used to force <i><b>CEN</b></i> to 1 using either the TM or SE signals.
</p>


<div id="org048c747" class="figure">
<p><img src="figs/gated_clock_tst.png" alt="gated_clock_tst.png" />
</p>
</div>

<p>
Redo all configurations once more again for the modified rtl. Use the <code>dft_config.tcl</code> file that you
have created before, and configure the DFT.
</p>
<div class="org-src-container">
<pre class="src src-tcl">source ./cmd/dft_config.tcl
</pre>
</div>

<p>
Now you can begin the DFT synthesis. Execute the following commands:
</p>

<div class="org-src-container">
<pre class="src src-tcl">compile -scan
dft_drc
</pre>
</div>

<p>
When the result of the drc is satisfactory, then you can specify the scan chain and insert the dft as follows:
</p>
<div class="org-src-container">
<pre class="src src-tcl">set_scan_configuration -chain_count 1
set_scan_configuration -clock_mixing no_mix
set_scan_path chain1 -scan_data_in SERIAL_IN -scan_data_out SERIAL_OUT
insert_dft
set_scan_state scan_existing
</pre>
</div>

<div class="org-src-container">
<pre class="src src-tcl">report_scan_path -view existing_dft -chain all &gt; reports/chain.rep
report_scan_path -view existing_dft -cell all &gt; reports/cell.rep
</pre>
</div>

<p>
After top-level scan insertion, we need different files for test pattern generation
with TetraMax from synopsys. Write out the test protocol file in Standard Test Interface
Language (STIL) format (the only supported format) and write out a Verilog or VHDL
top-level netlist for the top-level design. For example, use the following tcl commands 
to save the necessary files as follows:
</p>

<div class="org-src-container">
<pre class="src src-tcl">change_names -hierarchy -rule verilog
write -format verilog -hierarchy -out results/waveform_gen.vg
write -format ddc -hierarchy -output results/waveform_gen.ddc
write_scan_def -output results/waveform_gen.def
set test_stil_netlist_format verilog
write_test_protocol -output results/waveform_gen.stil
</pre>
</div>

<p>
Using the above commands, we write a gate level netlist <code>.vg</code>. <code>set test_stil_netlist_format verilog</code> command 
identifies the netlist format that you are exporting to TetraMAX ATPG. We also write out the test protocol file using the 
<code>write_test_protocol</code> command. Now, use <code>remove_design</code> command the remove the design.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf12a879" class="outline-2">
<h2 id="orgf12a879"><span class="section-number-2">5.</span> ATPG</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org5a5fb54" class="outline-3">
<h3 id="org5a5fb54"><span class="section-number-3">5.1.</span> Lunch TetraMAX</h3>
<div class="outline-text-3" id="text-5-1">
<p>
In this part, we want to use the TetraMax from synopsys to create the test patterns. 
Redirect to the tetramex folder <code>cd dft/tetramx</code> and start the software by using the following
command:
</p>

<div class="org-src-container">
<pre class="src src-sh">export PATH="/usrf01/prog/synopsys/txs/R-2020.09-SP4/bin:${PATH}"
tmax
</pre>
</div>


<div id="org5260969" class="figure">
<p><img src="figs/tmax_open.png" alt="tmax_open.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org406a380" class="outline-3">
<h3 id="org406a380"><span class="section-number-3">5.2.</span> Read the netlist and library files</h3>
<div class="outline-text-3" id="text-5-2">
<p>
In this step, we read the gate level netlist of the design as well as the library definition 
of each cell in verilog format. Browse the netlists and add the verilog netlist of the design from 
the <code>dft/do_synth/results</code> directory. Moreover, add the nangate library in verilog format in 
<code>0_FreePDK45/Verilog/NangateOpenCellLibrary.v</code> directory. 
</p>


<div id="org2b60938" class="figure">
<p><img src="figs/tmax_read_netlist.png" alt="tmax_read_netlist.png" />
</p>
</div>
</div>
</div>


<div id="outline-container-orge5d7bfa" class="outline-3">
<h3 id="orge5d7bfa"><span class="section-number-3">5.3.</span> Build the design</h3>
<div class="outline-text-3" id="text-5-3">
<p>
The Run Build Model dialog box sets the relevant parameters and builds the in-memory simulation 
model from the design modules that have been read in. TetraMAX ATPG performs a learning process, 
which you can control with this dialog. If a simulation model already exists, it is automatically 
deleted before the new model is built. Select the <b>Build</b> from the menu bar and select your top 
design. We use default options of <i><b>Set learning</b></i> box.
</p>


<div id="org366a0a3" class="figure">
<p><img src="figs/tmax_build.png" alt="tmax_build.png" />
</p>
</div>

<p>
After selecting the top module, select <i><b>Set Build Options</b></i> and add SRAM as black box.
</p>


<div id="orgcb16d2b" class="figure">
<p><img src="figs/tmax_build_black_box.png" alt="tmax_build_black_box.png" />
</p>
</div>
</div>
</div>


<div id="outline-container-org16f6d91" class="outline-3">
<h3 id="org16f6d91"><span class="section-number-3">5.4.</span> DRC check</h3>
<div class="outline-text-3" id="text-5-4">
<p>
Now, we perform design rule checking (DRC). First, specifie the name of the STIL procedures 
file that defines the scan chains and test procedures, then click on <code>Run</code>.
</p>


<div id="org367b71b" class="figure">
<p><img src="figs/tmax_drc.png" alt="tmax_drc.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgdca65ad" class="outline-3">
<h3 id="orgdca65ad"><span class="section-number-3">5.5.</span> Generate the test pattern</h3>
<div class="outline-text-3" id="text-5-5">
<p>
After you have imported the design and completed the DRC check without error, you
can use TetraMax to create the test patterns. First, the errors should be annotated. 
In our case, we would like to check all stuck-at errors. 
Use the following two commands to annotate the errors and generate the test
patterns:
</p>

<div class="org-src-container">
<pre class="src src-tcl">add_faults -all
run_atpg -auto
</pre>
</div>

<pre class="example" id="org3080ff5">
ATPG performed for stuck fault model using internal pattern source. 
 ---------------------------------------------------------- 
 #patterns     #faults     #ATPG faults  test      process 
 stored     detect/active  red/au/abort  coverage  CPU time 
 ---------  -------------  ------------  --------  -------- 
 Begin deterministic ATPG: #uncollapsed_faults=1420, abort_limit=10... 
 32           1401     14         2/3/0    92.23%      0.03 
 37              6      0         3/9/0    92.58%      0.03 

     Uncollapsed Stuck Fault Summary Report 
 ----------------------------------------------- 
 fault class                     code   #faults 
 ------------------------------  ----  --------- 
 Detected                         DT       1837 
 Possibly detected                PT          7 
 Undetectable                     UD         50 
 ATPG untestable                  AU        144 
 Not detected                     ND          0 
 ----------------------------------------------- 
 total faults                              2038 
 test coverage                            92.58% 
 ----------------------------------------------- 
            Pattern Summary Report 
 ----------------------------------------------- 
 #internal patterns                          37 
     #basic_scan patterns                    37 
 ----------------------------------------------- 
            CPU Usage Summary Report 
 ----------------------------------------------- 
 Total CPU time                            0.03 
 ----------------------------------------------- 
</pre>

<p>
Finally, we write the generated pattern in binary format using the following tcl command:
</p>

<div class="org-src-container">
<pre class="src src-tcl">write_patterns waveform_gen_pattern.v -internal -format binary
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
